# Tests Firmware retraction G10 and G11 with Virtual SD Card ENABLED

DICTIONARY atmega2560.dict
CONFIG firmware_retraction_reset_on_clear_off.cfg

CLEAR_RETRACTION
G90
VERIFY_AXIS_POSITION AXIS=e EXPECTED=0.0
G28

####################################################### TESTING CLEAR RETRACTION
G1 X90.0 Y90.0 Z20.0

SET_RETRACTION RETRACT_LENGTH=2.5 UNRETRACT_EXTRA_LENGTH=0 Z_HOP_HEIGHT=2.0
# Test CLEAR_RETRACTION while unretracted
CLEAR_RETRACTION

# Test CLEAR_RETRACTION while retracted
G10
VERIFY_AXIS_POSITION AXIS=z EXPECTED=22.0
VERIFY_AXIS_POSITION AXIS=e EXPECTED=-2.5
CLEAR_RETRACTION
VERIFY_AXIS_POSITION AXIS=z EXPECTED=22.0
VERIFY_AXIS_POSITION AXIS=e EXPECTED=-2.5

# Unretract after clearing retraction
G11
VERIFY_AXIS_POSITION AXIS=z EXPECTED=22.0
VERIFY_AXIS_POSITION AXIS=e EXPECTED=-2.5

# Test CLEAR_RETRACTION while retracted, 2nd go
SET_RETRACTION Z_HOP_HEIGHT=3.0
G10
VERIFY_AXIS_POSITION AXIS=z EXPECTED=25.0
VERIFY_AXIS_POSITION AXIS=e EXPECTED=-5.0
CLEAR_RETRACTION
VERIFY_AXIS_POSITION AXIS=z EXPECTED=25.0
VERIFY_AXIS_POSITION AXIS=e EXPECTED=-5.0

# Unretract after clearing retraction and retracting
G10
VERIFY_AXIS_POSITION AXIS=z EXPECTED=28.0
VERIFY_AXIS_POSITION AXIS=e EXPECTED=-7.5
CLEAR_RETRACTION
G11
VERIFY_AXIS_POSITION AXIS=z EXPECTED=28.0
VERIFY_AXIS_POSITION AXIS=e EXPECTED=-7.5
G10
VERIFY_AXIS_POSITION AXIS=z EXPECTED=31.0
VERIFY_AXIS_POSITION AXIS=e EXPECTED=-10.0

# Test first move with z coordinate after retraction was cleared
G1 X100.0 Y100.0 Z28.0
VERIFY_AXIS_POSITION AXIS=x EXPECTED=100.0
VERIFY_AXIS_POSITION AXIS=y EXPECTED=100.0
VERIFY_AXIS_POSITION AXIS=z EXPECTED=31.0
VERIFY_AXIS_POSITION AXIS=e EXPECTED=-10.0
G11
VERIFY_AXIS_POSITION AXIS=z EXPECTED=28.0
VERIFY_AXIS_POSITION AXIS=e EXPECTED=-7.0
M118 Test successful!
